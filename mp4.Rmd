---
title: "Mini-Project 4"
author: "Eleanor Ewing, Max Ranieri, Farah Samawi"
date: "12/02/2017"
output: 
  html_document:
    code_folding: hide
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(mdsr)
library(RMySQL)
library(readr)
library(RColorBrewer)
```

```{r}
# Connect to IMDb
db <- dbConnect_scidb(dbname = "imdb")

# Get genre info
query_genre <- 
  "SELECT movie_id, 
    COUNT(CASE WHEN info_type_id = 3 THEN info ELSE NULL END) AS genres,
    production_year
  FROM imdb.movie_info
  LEFT JOIN title ON movie_info.movie_id = title.id
  WHERE kind_id = 1 AND 
    production_year IS NOT NULL AND 
    production_year > 1909 AND production_year < 2018 AND
    info IS NOT NULL AND 
    movie_id IN (SELECT movie_id
                  FROM movie_info
                  WHERE info_type_id = 8 AND 
                  info LIKE '%USA%')
  GROUP BY movie_id;"

genre_data <- db %>%
  dbGetQuery(query_genre) 

# Get user rating info
query_rating <-
  "SELECT movie_id, 
    info AS rating
  FROM imdb.movie_info_idx
  LEFT JOIN title ON movie_info_idx.movie_id = title.id
  WHERE kind_id = 1 AND
    production_year IS NOT NULL AND
    info_type_id = 101 AND
    info IS NOT NULL;"

rating_data <- db %>%
  dbGetQuery(query_rating)
```

```{r}
# Determine average number of genres per year
genres_by_year <- genre_data %>%
  group_by(production_year) %>%
  summarize(mean = mean(genres))

# Plotting year vs. average number of genres
ggplot(genres_by_year, aes(x = production_year, y = mean)) +
  geom_vline(aes(xintercept=1948), col="red") +
  geom_line(col = "black") +
  labs(x = "Year", y = "Average genre multiplicity") +
  theme_dark() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
```

```{r}
# Joining genre with ratings and cleaning up rating data
movie_data <- left_join(rating_data, genre_data, by = "movie_id") %>% 
  na.omit()

# Ratings are strings in the database, so we need to explicitly convert them
movie_data <- movie_data %>%
  mutate(rating = parse_number(rating))

# Ignore anything with 0 genres (missing data)
row_sub = apply(movie_data, 1, function(row) all(row !=0 ))
movie_data2 <- movie_data2[row_sub,]
```

```{r}
# Factorizing genres into 3 categories, 1-3 genres, 4-6, and 7+
movie_data <- movie_data %>%
  mutate(genres =
    ifelse(genres < 4,
      1,
      ifelse(genres < 6,
        2,
        3
        )
      )
  )
```

```{r}
# Preparing to plot movie_data
movie_data <- movie_data %>%
  group_by(genres, production_year) %>%
  summarize(rating = mean(rating))

# Customizing a ColorBrewer color set
spectral2 = brewer.pal(4, "Spectral")

# Plot that movie data!
ggplot(movie_data, aes(x = production_year, y = rating, color=factor(genres))) +
  geom_line(alpha = 0.8) +
  scale_color_manual(values = spectral2, 
                     labels = c("1-3", "4-6", "7+"), 
                     name = "Genres") +
  theme_dark() +
  labs(x = "Year", y = "User rating") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```