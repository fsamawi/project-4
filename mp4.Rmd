---
title: "Mini-Project 4"
author: "Eleanor Ewing, G.E. Ranieri, Farah Samawi"
date: "12/02/2017"
output: 
  html_document:
    code_folding: hide
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(mdsr)
library(RMySQL)
library(readr)
library(RColorBrewer)
```

```{r}
db <- dbConnect_scidb(dbname = "imdb")
query_genre <- "SELECT movie_id, 
	               COUNT(CASE WHEN info_type_id = 3 THEN info ELSE NULL END) AS genres,
	               production_year
          FROM imdb.movie_info
          LEFT JOIN title ON movie_info.movie_id = title.id
          WHERE kind_id = 1 AND 
	              production_year IS NOT NULL AND 
                production_year > 1909 AND production_year < 2000 AND
	              info IS NOT NULL AND 
	              movie_id IN (SELECT movie_id
				                     FROM movie_info
				                     WHERE info_type_id = 8 AND info LIKE '%USA%')
          GROUP BY movie_id;"

genre_data <- db %>%
  dbGetQuery(query_genre) 
```

```{r}
genres_by_year <- genre_data %>%
  group_by(production_year) %>%
  summarize(mean = mean(genres))

ggplot(genres_by_year, aes(x = production_year, y = mean)) +
  geom_line()
```

```{r}
query_gross <- "SELECT movie_id, info AS gross
  FROM imdb.movie_info
  LEFT JOIN title ON movie_info.movie_id = title.id
  WHERE kind_id = 1 AND production_year IS NOT NULL AND
  info_type_id = 107"
  
gross_data <- db %>%
  dbGetQuery(query_gross)
  
movie_data <- left_join(gross_data, genre_data, by = "movie_id") %>% na.omit()

numberize <- function(str) {
  parse_number(sub(" .*", "", str))
}

movie_data <- movie_data %>%
  filter(substr(gross, 1, 1) == "$") %>%
  filter(grepl("*\\(USA\\)*", gross)) %>%
  mutate(gross = numberize(gross)) %>%
  group_by(movie_id) %>%
  summarize(gross = max(gross), genres = max(genres), production_year = max(production_year))
```

```{r}
# remove 0's
row_sub = apply(movie_data, 1, function(row) all(row !=0 ))
movie_data <- movie_data[row_sub,]

# movie_data <- movie_data %>% 
#   mutate(genres = 
#     ifelse(genres < 4,
#       1,
#       ifelse(genres < 6,
#         2,
#         ifelse(genres < 9,
#           3,
#           4)
#         )
#       )
#   )
```

```{r}
ggplot(movie_data, aes(x = production_year, y = genres, col = gross )) +
  geom_jitter(alpha = 0.1)
```